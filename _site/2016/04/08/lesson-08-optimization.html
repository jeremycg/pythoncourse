<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Lesson 08 - Optimization</title>
  <meta name="description" content="Lesson 08 - Python Optimization">

  <link rel="stylesheet" href="/pythoncourse/css/main.css">
  <link rel="canonical" href="http://jeremy.kiwi.nz/pythoncourse/pythoncourse/2016/04/08/lesson-08-optimization.html">
  <link rel="alternate" type="application/rss+xml" title="Python @ Precima" href="http://jeremy.kiwi.nz/pythoncourse/pythoncourse/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/pythoncourse/">Python @ Precima</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
          <a class="page-link" href="/pythoncourse/tag/Applied%20Statistics%20stream/">Applied Statistics stream</a>
          
        
          
          <a class="page-link" href="/pythoncourse/tag/R&D%20stream/">R&D stream</a>
          
        
      </div>
    </nav>

  </div>

</header>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73837623-1', 'auto');
  ga('send', 'pageview');

</script>

    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Lesson 08 - Optimization</h1>
    <p class="post-meta"><time datetime="2016-04-08T00:00:00-04:00" itemprop="datePublished">Apr 8, 2016</time> â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jeremy</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="lesson-08---python-optimization">Lesson 08 - Python Optimization</h2>

<p>Welcome to lesson 9. This lesson we will deepen our understanding of Python, and
learn how to optimise our code through profiling, benchmarking and timing.</p>

<p>We will also learn the general methods of error handling and raising, and how to
automatically test code to make sure it is carrying out what we want it to do.</p>

<p>Firstly however, we will learn a little more about generators.</p>

<p>Download <a href="/pythoncourse/assets/notebooks/r&amp;d/Lesson 08 - Optimization.ipynb">todays notebook here</a></p>

<h3 id="iterables-and-generators">Iterables and Generators</h3>

<p>Letâ€™s go back to when we introduced zip:</p>

<p><strong>In [118]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#taken from comments on the site</span>
<span class="n">l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">k</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="n">a</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>[(1, 4), (2, 5), (3, 6)]
[]
</code></pre>
</div>

<p>Huh, why didâ€™t the second one work?</p>

<p>It turns out, many of the maps, zips etc in python 3 are implemented as
iterators. These objects allow us to generate a single part at each step,
without storing it all in memory (these are based on range, but work a little
differently).</p>

<p><strong>In [119]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">a</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>(1, 4)
(2, 5)
(3, 6)
[]
</code></pre>
</div>

<p>We can iterate over any iterable in a for loop:</p>

<p><strong>In [120]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
2
3
</code></pre>
</div>

<p>But to eplicit make it an iterator, we use the iter() function:</p>

<p><strong>In [121]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">j</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">j</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
2
3



---------------------------------------------------------------------------

StopIteration                             Traceback (most recent call last)

&lt;ipython-input-121-31e9e4b4925c&gt; in &lt;module&gt;()
      3 print(next(j))
      4 print(next(j))
----&gt; 5 print(next(j))


StopIteration:
</code></pre>
</div>

<p>Turning a preexisitng object into an iterator is not very useful however, as we
already have it in memory.</p>

<p>If we want to create a function to make our output, we can use a generator
function</p>

<p>Generator functuions work very similar to standard functions, but use the yield
keyword, rather than return:</p>

<p><strong>In [129]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">mygen</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">n</span>
    <span class="k">yield</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">mygen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;generator object mygen at 0x7f18a3ed0830&gt;
10
11
</code></pre>
</div>

<p>Or, a fibonacci implementation:</p>

<p><strong>In [130]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">a</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
1
2
3
5
8
13
21
34
55
</code></pre>
</div>

<p>This is also why we canâ€™t do tuple comprehensions - the syntax is reserved for
making generator expressions:</p>

<p><strong>In [131]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
2
3



---------------------------------------------------------------------------

StopIteration                             Traceback (most recent call last)

&lt;ipython-input-131-0f1ad886ef79&gt; in &lt;module&gt;()
      4 print(next(g))
      5 print(next(g))
----&gt; 6 print(next(g))


StopIteration:
</code></pre>
</div>

<p>In general, we can think of generators as a â€˜lazy listâ€™ - a way of storing how
to get the next object, without taking up all the memory.</p>

<h3 id="working-with-large-files">Working with large files</h3>

<p>In general Python holds the data we have in memory. We need to come up with ways
to handle larger data out of memory in piecemeal (or buy more RAM). Most methods
are specific to a certain type of data, but we will cover a general method for
now.</p>

<p>We can open a file on the disk in Python, as long as we use the correct
permissions (read_csv from pandas took care of this for us). Letâ€™s download the
test example data -
http://jeremy.kiwi.nz/pythoncourse/assets/tests/r&amp;d/test1data.csv</p>

<p><strong>In [132]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">g</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/home/jeremy/Downloads/test1data.csv'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;_io.TextIOWrapper name='/home/jeremy/Downloads/test1data.csv' mode='r' encoding='UTF-8'&gt;
</code></pre>
</div>

<p>We need to specify a â€˜modeâ€™ to open our file - I have chosen r for read, we can
also use w for writing (this deletes the exsiting file), a for appending, and r+
for writing/andor reading.</p>

<p>The file is not read in straight away - we merely have a pointer to the file. We
can read the next line as though it was created using a generator:</p>

<p><strong>In [133]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#nextline</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>TripType,VisitNumber,Weekday,Upc,ScanCount,DepartmentDescription,FinelineNumber

999,5,Friday,68113152929,-1,FINANCIAL SERVICES,1000
</code></pre>
</div>

<p>If you want to read all the lines of a file in a list you can also use list(f),
f.readlines() or f.read().</p>

<p>Once we are done with a file, we need to close it:</p>

<p><strong>In [134]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>But, this doesnâ€™t help use too much - we can imagine reading in enough files ot
fill our memory, and then carrying out some analysis, then reading in more.</p>

<p>Luckily, we have the with statement and generators:</p>

<p><strong>In [135]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/home/jeremy/Downloads/test1data.csv'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">head</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

<span class="k">print</span><span class="p">(</span><span class="n">head</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>['TripType,VisitNumber,Weekday,Upc,ScanCount,DepartmentDescription,FinelineNumber', '999,5,Friday,68113152929,-1,FINANCIAL SERVICES,1000', '30,7,Friday,60538815980,1,SHOES,8931', '30,7,Friday,7410811099,1,PERSONAL CARE,4504', '26,8,Friday,2238403510,2,PAINT AND ACCESSORIES,3565']
</code></pre>
</div>

<p><strong>In [136]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">partread</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span>

<span class="n">lines</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">partread</span><span class="p">(</span><span class="s">'/home/jeremy/Downloads/test1data.csv'</span><span class="p">)</span>
<span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lines</span><span class="p">)]</span>
<span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lines</span><span class="p">)]</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>['26,8,Friday,2006613744,2,PAINT AND ACCESSORIES,1017',
 '26,8,Friday,2006618783,2,PAINT AND ACCESSORIES,1017',
 '26,8,Friday,2006613743,1,PAINT AND ACCESSORIES,1017',
 '26,8,Friday,7004802737,1,PAINT AND ACCESSORIES,2802',
 '26,8,Friday,2238495318,1,PAINT AND ACCESSORIES,4501']
</code></pre>
</div>

<p>Pandas also has a built-in methods to generate an interator:</p>

<p><strong>In [137]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'/home/jeremy/Downloads/test1data.csv'</span><span class="p">,</span> <span class="n">iterator</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;pandas.io.parsers.TextFileReader object at 0x7f1883699ac8&gt;
</code></pre>
</div>

<p><strong>In [138]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">x</span><span class="o">.</span><span class="n">get_chunk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></figure>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TripType</th>
      <th>VisitNumber</th>
      <th>Weekday</th>
      <th>Upc</th>
      <th>ScanCount</th>
      <th>DepartmentDescription</th>
      <th>FinelineNumber</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>999</td>
      <td>5</td>
      <td>Friday</td>
      <td>68113152929</td>
      <td>-1</td>
      <td>FINANCIAL SERVICES</td>
      <td>1000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30</td>
      <td>7</td>
      <td>Friday</td>
      <td>60538815980</td>
      <td>1</td>
      <td>SHOES</td>
      <td>8931</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30</td>
      <td>7</td>
      <td>Friday</td>
      <td>7410811099</td>
      <td>1</td>
      <td>PERSONAL CARE</td>
      <td>4504</td>
    </tr>
    <tr>
      <th>3</th>
      <td>26</td>
      <td>8</td>
      <td>Friday</td>
      <td>2238403510</td>
      <td>2</td>
      <td>PAINT AND ACCESSORIES</td>
      <td>3565</td>
    </tr>
    <tr>
      <th>4</th>
      <td>26</td>
      <td>8</td>
      <td>Friday</td>
      <td>2006613744</td>
      <td>2</td>
      <td>PAINT AND ACCESSORIES</td>
      <td>1017</td>
    </tr>
  </tbody>
</table>
</div>

<p>There are more sensible workflows using large data technologies - for now we
will move on.</p>

<h3 id="error-and-exception-handling">Error and Exception handling</h3>

<p>Itâ€™s easier to ask forgiveness than it is to get permission. - Grace Hopper</p>

<p>We can often program more easily, if we simply try to do something, and then
handle the failure. Errors will however break our code if we are not careful, so
we can build in fail safe methods to handle errors:</p>

<p><strong>In [139]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'testfile'</span><span class="p">,</span><span class="s">'r'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>---------------------------------------------------------------------------

FileNotFoundError                         Traceback (most recent call last)

&lt;ipython-input-139-9b568190695a&gt; in &lt;module&gt;()
----&gt; 1 f = open('testfile','r')


FileNotFoundError: [Errno 2] No such file or directory: 'testfile'
</code></pre>
</div>

<p>We can try to do this, using the try statement, and an exception:</p>

<p><strong>In [140]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'testfile'</span><span class="p">,</span><span class="s">'r'</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'file not found'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>file not found
</code></pre>
</div>

<p>Now we have no longer raised an error serious enough to stop our script (whether
this is bad or good is up to you). We can also specify the <a href="https://docs.python.org/3/library/exceptions.html#bltin-exceptions">type of
error</a> we
will catch (more specific is better):</p>

<p><strong>In [141]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'testfile'</span><span class="p">,</span><span class="s">'r'</span><span class="p">)</span>
<span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'file not found'</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'type error!'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>file not found
</code></pre>
</div>

<p><strong>In [142]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'file not found'</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'type error!'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>type error!
</code></pre>
</div>

<p>We can add on a final else which is only completed if we did not raise an error:</p>

<p><strong>In [143]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'file not found'</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'type error!'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'operation sucessful'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>operation sucessful
</code></pre>
</div>

<p>We can use finally to run a piece of code whether or not we were sucessful,
which is useful for cleanup:</p>

<p><strong>In [144]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'file not found'</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'type error!'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'operation sucessful'</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="k">del</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'cleanedup'</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>type error!
cleanedup
</code></pre>
</div>

<p>Still to come - unit testing and parallel prcoessing</p>

<h3 id="debugging">Debugging</h3>

<p>We have an interactive debugger in iPython, called after an error using the
%debug command. Using this we can trace back our errors, see current values, and
step forward in code:</p>

<p><strong>In [145]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">thisisnotadefinedvariable</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-145-091615ac5c44&gt; in &lt;module&gt;()
----&gt; 1 thisisnotadefinedvariable


NameError: name 'thisisnotadefinedvariable' is not defined
</code></pre>
</div>

<p><strong>In [146]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">debug</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt; [1;32m&lt;ipython-input-145-091615ac5c44&gt;[0m(1)[0;36m&lt;module&gt;[1;34m()[0m
[1;32m----&gt; 1 [1;33m[0mthisisnotadefinedvariable[0m[1;33m[0m[0m
[0m
ipdb&gt; exit
</code></pre>
</div>

<p>In the debugger we have a lot of commands - use h or help to get them. Useful
are c for continue, q for quit, n for next line, s for step into function, u/d
for up/down in the call stack and l for listing the code.</p>

<p>The <a href="https://docs.python.org/3.5/library/pdb.html">help page is available
online</a>.</p>

<p>The easiest way to debug problematic code is to manually enter a breakpoint,
using pdb.set_trace(). From here you will enter the debugger, and have access to
all the variables available in the cirrent environment.</p>

<p><strong>In [147]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pdb</span></code></pre></figure>

<p><strong>In [148]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">acounter</span><span class="p">,</span> <span class="n">bcounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">acounter</span>
        <span class="n">acounter</span><span class="p">,</span> <span class="n">bcounter</span> <span class="o">=</span> <span class="n">bcounter</span><span class="p">,</span> <span class="n">acounter</span> <span class="o">+</span> <span class="n">bcounter</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">each</span><span class="p">)</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
&gt; &lt;ipython-input-148-113b0f967fab&gt;(3)fib()
-&gt; for i in range(num):
(Pdb) exit



---------------------------------------------------------------------------

BdbQuit                                   Traceback (most recent call last)

&lt;ipython-input-148-113b0f967fab&gt; in &lt;module&gt;()
      6         pdb.set_trace()
      7
----&gt; 8 for each in fib(10):
      9     print(each)


&lt;ipython-input-148-113b0f967fab&gt; in fib(num)
      1 def fib(num):
      2     acounter, bcounter = 1, 1
----&gt; 3     for i in range(num):
      4         yield acounter
      5         acounter, bcounter = bcounter, acounter + bcounter


&lt;ipython-input-148-113b0f967fab&gt; in fib(num)
      1 def fib(num):
      2     acounter, bcounter = 1, 1
----&gt; 3     for i in range(num):
      4         yield acounter
      5         acounter, bcounter = bcounter, acounter + bcounter


/home/jeremy/anaconda3/lib/python3.5/bdb.py in trace_dispatch(self, frame, event, arg)
     46             return # None
     47         if event == 'line':
---&gt; 48             return self.dispatch_line(frame)
     49         if event == 'call':
     50             return self.dispatch_call(frame, arg)


/home/jeremy/anaconda3/lib/python3.5/bdb.py in dispatch_line(self, frame)
     65         if self.stop_here(frame) or self.break_here(frame):
     66             self.user_line(frame)
---&gt; 67             if self.quitting: raise BdbQuit
     68         return self.trace_dispatch
     69


BdbQuit:
</code></pre>
</div>

<h3 id="profiling-and-timing">Profiling and Timing</h3>

<p>We have already briefly covered %timeit: This is magic function which runs code
and gives us the execution time. We have the very similar magic function %time:</p>

<p><strong>In [149]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">%</span><span class="n">time</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
<span class="o">%</span><span class="n">time</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>CPU times: user 510 Âµs, sys: 0 ns, total: 510 Âµs
Wall time: 581 Âµs
CPU times: user 27.6 ms, sys: 20.1 ms, total: 47.7 ms
Wall time: 51.2 ms





array([    0,     1,     2, ..., 99997, 99998, 99999])
</code></pre>
</div>

<p>%time runs our command once, and reports the CPU time and wall time.</p>

<p>%timeit runs our command multiple times (It aims for five seconds), and reports
the average times. One caveat is timeit turns off the garbage collector - so if
we are deleting a lot of things we might be misled. We can use the <a href="https://docs.python.org/3.5/library/timeit.html">timeit
module</a> for more fine grain
control if needed</p>

<p><strong>In [150]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1000 loops, best of 3: 456 Âµs per loop
10 loops, best of 3: 44.6 ms per loop
</code></pre>
</div>

<p>We can also use profiling tools!</p>

<p>First, we have the %prun magic method. This allows us to profile multiple
function calls:</p>

<p><strong>In [151]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%%</span><span class="n">prun</span> <span class="c">#-l fibo</span>
<span class="c">#two % tell us to do a multi line magic!</span>
<span class="k">def</span> <span class="nf">fibo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="n">fibo</span><span class="p">(</span><span class="mi">500000</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5000000</span><span class="p">)</span></code></pre></figure>

<p>Now this is not super useful - only if we have a large file with multiple
functions. We could probably just use %time or %%timeit.</p>

<p>If we want to go line by line, we need the line profiler module (conda install
line profiler). We then need to load it as an iPython extension, rather than a
module:</p>

<p><strong>In [152]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">load_ext</span> <span class="n">line_profiler</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>The line_profiler extension is already loaded. To reload it, use:
  %reload_ext line_profiler
</code></pre>
</div>

<p><strong>In [153]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">f</span> <span class="n">fibo</span> <span class="n">fibo</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<span class="c">#we do lprun -f function statement</span></code></pre></figure>

<p>In the same manner, we can do memory profiling, using the <a href="https://pypi.python.org/pypi/memory_profiler">memory_profiler
module</a></p>

<p><strong>In [154]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">load_ext</span> <span class="n">memory_profiler</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>The memory_profiler extension is already loaded. To reload it, use:
  %reload_ext memory_profiler
</code></pre>
</div>

<p><strong>In [155]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="o">%</span><span class="n">mprun</span> <span class="o">-</span><span class="n">f</span> <span class="n">fibo</span> <span class="n">fibo</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<span class="c">#doesnt work unless we run a file!</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>ERROR: Could not find file &lt;ipython-input-155-4a4111679972&gt;
NOTE: %mprun can only be used on functions defined in physical files, and not in the IPython environment.
</code></pre>
</div>

<p>We can also use the %memit magic (Here Iâ€™m showing I was not lieing about the
range function being efficient):</p>

<p><strong>In [156]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">memit</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
<span class="o">%</span><span class="n">memit</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">))</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>peak memory: 182.58 MiB, increment: 0.15 MiB
peak memory: 217.49 MiB, increment: 34.91 MiB
</code></pre>
</div>

<h3 id="magic-commands">Magic Commands</h3>

<p>Just as an aside, we can see we can import magic commands from multiple
packages, and <a href="https://ipython.readthedocs.org/en/stable/in
teractive/magics.html?highlight=magics">have a lot built in</a>. Here are two of my favourites:</p>

<p><strong>In [157]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%%</span><span class="n">bash</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="sb">`seq 1 10`</span><span class="p">;</span> <span class="n">do</span>
<span class="n">echo</span> <span class="err">$</span><span class="n">i</span>
<span class="n">done</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>1
2
3
4
5
6
7
8
9
10
</code></pre>
</div>

<p><strong>In [158]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%%</span><span class="n">latex</span>
\<span class="n">begin</span><span class="p">{</span><span class="n">align</span><span class="p">}</span>
\<span class="n">nabla</span> \<span class="n">times</span> \<span class="n">vec</span><span class="p">{</span>\<span class="n">mathbf</span><span class="p">{</span><span class="n">B</span><span class="p">}}</span> <span class="o">-</span>\<span class="p">,</span> \<span class="n">frac1c</span>\<span class="p">,</span> \<span class="n">frac</span><span class="p">{</span>\<span class="n">partial</span>\<span class="n">vec</span><span class="p">{</span>\<span class="n">mathbf</span><span class="p">{</span><span class="n">E</span><span class="p">}}}{</span>\<span class="n">partial</span> <span class="n">t</span><span class="p">}</span> <span class="o">&amp;</span> <span class="o">=</span> \<span class="n">frac</span><span class="p">{</span><span class="mi">4</span>\<span class="n">pi</span><span class="p">}{</span><span class="n">c</span><span class="p">}</span>\<span class="n">vec</span><span class="p">{</span>\<span class="n">mathbf</span><span class="p">{</span><span class="n">j</span><span class="p">}}</span> \\
\<span class="n">end</span><span class="p">{</span><span class="n">align</span><span class="p">}</span></code></pre></figure>

<p>\begin{align}
\nabla \times \vec{\mathbf{B}} -\, \frac1c\, \frac{\partial\vec{\mathbf{E}}}{\partial t} &amp; = \frac{4\pi}{c}\vec{\mathbf{j}} <br />
\end{align}</p>

<h3 id="testing">Testing</h3>

<p>Test driven development is a development style where we write tests that out
completed code should pass, then attempt to write code to pass them. In this
manner, we can ensure that our code works as desired, and gives outputs that we
desire.</p>

<p>To a lesser extent, all code should include tests - a lot of time spent
debugging and writing code is simply manual testing - why didnâ€™t my code work?
Why did this particular data give me an error? What about special edge cases?</p>

<p>This informal testing is often all that code goes through. Code reviews, and
Pair Programming have been shown to help reduce bugs, but a good start is unit
testing.</p>

<p>Unit testing allows us to test each part (unit) of our code automatically, and
can greatly help in refactoring large code bases, or prexisting code bases. We
could theoretically completely rewrite entire scripts and keep the same tests,
so that our inputs and outputs stay identical.</p>

<p>There are a <a href="http://docs.python-
guide.org/en/latest/writing/tests/">wide range of testing suites available</a>, here we will use the <a href="https://docs.python.org/3/library/unittest.html">unittest
module</a> from the standard
library.</p>

<p><strong>In [159]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">unittest</span></code></pre></figure>

<p>unittest works best with scripts - Letâ€™s make one with our fibonacci functions
form the second lesson:</p>

<p><strong>In [None]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="c">#saved as fibo.py</span></code></pre></figure>

<p>The we create a seperate script, which imports unittest, and define our tests as
a class which inherits from unittest.TestCase. All of our tests are methods of
this class, and must start with test.</p>

<p>We then use the range of assert* methods built in to the class to say what our
functions should do:</p>

<p><strong>In [None]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">fibo</span> <span class="kn">import</span> <span class="n">fibo</span>

<span class="k">class</span> <span class="nc">testfibo</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fibo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fibo</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">,</span> <span class="n">fibo</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fibo</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">55</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="c">#saved as tests.py</span></code></pre></figure>

<p><code class="highlighter-rouge">python tests.py</code></p>

<p>```
jeremy@thin:~$ python tests.py
F..F
======================================================================
FAIL: test_negative (<strong>main</strong>.testfibo)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
Traceback (most recent call last):
  File â€œtests.pyâ€, line 10, in test_negative
    self.assertRaises(ValueError, fibo, -1)
AssertionError: ValueError not raised by fibo</p>

<p>======================================================================
FAIL: test_zero (<strong>main</strong>.testfibo)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
Traceback (most recent call last):
  File â€œtests.pyâ€, line 8, in test_zero
    self.assertEqual(fibo(0), 0)
AssertionError: 1 != 0</p>

<hr />
<p>Ran 4 tests in 0.002s</p>

<p>FAILED (failures=2)
```</p>

<p>Then we can fix our function:</p>

<p><strong>In [None]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="c">#saved as fibo.py</span></code></pre></figure>

<p>And rerun our tests.</p>

<p>We know that this is a slow function, so maybe we would like to refactor it. We
can do this, leaving the tests as is:</p>

<p><strong>In [None]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="n">myfunction</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">function_to_cache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">=</span> <span class="n">myfunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">function_to_cache</span>

<span class="k">def</span> <span class="nf">fiborecur</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">fiborecur</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fiborecur</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="c">#saved as fibo.py</span></code></pre></figure>

<p>Whoops - our refactor didnâ€™t define fibo - We could do this in our script, but
maybe we donâ€™t want to for now.</p>

<p>We have the setUp and tearDown methods - using these we can run code to set up
our tests - eg connect to a database or download some data. In general, we
should keep any set up inside our class - we donâ€™t want to modify the global
environment for any other tests.</p>

<p><strong>In [None]:</strong></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">fibo</span> <span class="kn">import</span> <span class="n">fiborecur</span>
<span class="kn">from</span> <span class="nn">fibo</span> <span class="kn">import</span> <span class="n">memoize</span>

<span class="k">class</span> <span class="nc">testfibo</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fibo</span> <span class="o">=</span> <span class="n">memoize</span><span class="p">(</span><span class="n">fiborecur</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fibo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fibo</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_negative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fibo</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fibo</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">55</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="c">#saved as tests.py</span></code></pre></figure>

<p>We forgot our initial bug fixes - lucky we had tests!</p>

  </div>
  
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'jeremycg';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  
</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Python @ Precima</h2>



  </div>

</footer>


  </body>

</html>
